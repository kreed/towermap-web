<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>T-Mobile Tower Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='dist/mapbox-gl.js'></script>
<link href='dist/mapbox-gl.css' rel='stylesheet' />
<script src='tmo.js'></script>
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia3JlM2QiLCJhIjoieU9KWThOUSJ9.lMOWQzER-r4HQZwX8vIWbw';

for (var i = 0; i < towers.features.length; ++i) {
	var p = towers.features[i].properties;
	var icons = ['lattice', 'guyed', 'monopole', 'building', 'water_tower'];
	var struct = icons.indexOf(p.structure) == -1 ? 'default' : p.structure;
	p._icon = struct + '_' + (p.band || "unknown").replace(/;/g, '_');
}

var style = {
	"version": 8,
	"sprite": "towers",
	"sources": {
		"mapbox": {
			"type": "raster",
			"url": "mapbox://mapbox.satellite",
			"tileSize": 256
		},
		"tmo": {
			"type": "raster",
			"tiles": ["tiles/1448368781/b12/{z}/{x}/{y}.png"],
			"tileSize": 256,
			"maxzoom": 13,
		},
		"towers": {
			"type": "geojson",
			"data": towers,
		}
	},
	"layers": [{
		"id": "satellite",
		"type": "raster",
		"source": "mapbox",
	}, {
		"id": "tmo",
		"type": "raster",
		"source": "tmo",
		"paint": {
			"raster-opacity": 0.75,
		}
	}, {
		"id": "towers",
		"interactive": true,
		"type": "symbol",
		"source": "towers",
		"filter": ["!=", "hidden", "yes"],
		"layout": {
			"icon-image": "{_icon}",
			"icon-allow-overlap": true,
		}
	}]
};

var map = new mapboxgl.Map({
	container: "map",
	style: style,
	center: [-97.9865, 30.0273],
	zoom: 8,
	hash: true
});
map.addControl(new mapboxgl.Navigation());

map.on('click', function (e) {
	map.featuresAt(e.point, {layer: 'towers', radius: 12, includeGeometry: true}, function (err, features) {
		if (err || !features.length)
			return;

		var feature = features[0];

		var html = '';
		for (var p in feature.properties) {
			if (p[0] == '_') continue;
			html += '<tr><td>' + p + '</td><td>' + feature.properties[p] + '</td></tr>';
		}

		new mapboxgl.Popup()
			.setLngLat(feature.geometry.coordinates)
			.setHTML('<table>' + html + '</table>')
			.addTo(map);
	});
});

map.on('mousemove', function (e) {
	map.featuresAt(e.point, {layer: 'towers', radius: 12}, function (err, features) {
		map.getCanvas().style.cursor = (!err && features.length) ? 'pointer' : '';
	});
});
</script>
</body>
</html>
