<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>T-Mobile Tower Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='dist/mapbox-gl.js'></script>
<link href='dist/mapbox-gl.css' rel='stylesheet' />
<script src='tmo.js'></script>
<style>
body { margin:0; padding:0; }
#map { position: absolute; top: 35px; left: 0; right: 0; bottom: 0; }
#range { width: 100%; height: 35px; margin: 0; }
</style>
</head>
<body>
<div id='map'></div>
<input id='range' type='range' min='0' max='1.0' step='any' />
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia3JlM2QiLCJhIjoieU9KWThOUSJ9.lMOWQzER-r4HQZwX8vIWbw';

for (var i = 0; i < towers.features.length; ++i) {
	var p = towers.features[i].properties;
	var icons = ['lattice', 'guyed', 'monopole', 'building', 'water_tower'];
	var struct = icons.indexOf(p.structure) == -1 ? 'default' : p.structure;
	p._icon = struct.replace(/_/g, '-') + '-' + (p.band || "unknown").replace(/;/g, '-');
}

var map = new mapboxgl.Map({
	container: "map",
	style: 'style-chron.json',
	center: [-97.9865, 30.0273],
	zoom: 8,
});
map.addControl(new mapboxgl.Navigation());

map.on('style.load', function () {
	var range = document.getElementById('range');

	function clip() {
		var x = range.value * 2;
		map.getLayer('b12').clipMatrix = new Float32Array([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, x - 2, 0, 0, 1])
		map.getLayer('nob12').clipMatrix = new Float32Array([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, x, 0, 0, 1])
		map._rerender();
	}

	range['oninput' in range ? 'oninput' : 'onchange'] = clip;
	clip();
});

map.on('click', function (e) {
	map.featuresAt(e.point, {layer: 'towers', radius: 12, includeGeometry: true}, function (err, features) {
		if (err || !features.length)
			return;

		var feature = features[0];

		var html = '';
		for (var p in feature.properties) {
			if (p[0] == '_') continue;
			html += '<tr><td>' + p + '</td><td>' + feature.properties[p] + '</td></tr>';
		}

		new mapboxgl.Popup()
			.setLngLat(feature.geometry.coordinates)
			.setHTML('<table>' + html + '</table>')
			.addTo(map);
	});
});

map.on('mousemove', function (e) {
	map.featuresAt(e.point, {layer: 'towers', radius: 12}, function (err, features) {
		map.getCanvas().style.cursor = (!err && features.length) ? 'pointer' : '';
	});
});
</script>
</body>
</html>
